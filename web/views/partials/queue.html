{{ define "queueExplorer" }}
<section id="queue-explorer" class="card border shadow py-5 px-2 rounded-4 mb-4">
  <div class="bg-white justify-content-between text-md-center">
    <div>
      <h5 class="mb-2">Queue Explorer</h5>
      <p class="text-muted small mb-4">Filter jobs and trigger manual actions.</p>
    </div>
    <div class="btn-group" role="group" aria-label="Job filters">
      <button type="button" class="btn btn-sm btn-outline-primary jobs-filter active" data-status="">All</button>
      <button type="button" class="btn btn-sm btn-outline-primary jobs-filter" data-status="pending">Pending</button>
      <button type="button" class="btn btn-sm btn-outline-primary jobs-filter" data-status="running">Running</button>
      <button type="button" class="btn btn-sm btn-outline-primary jobs-filter" data-status="retry">Retry</button>
      <button type="button" class="btn btn-sm btn-outline-primary jobs-filter" data-status="failed">Failed</button>
      <button type="button" class="btn btn-sm btn-outline-primary jobs-filter" data-status="done">Completed</button>
    </div>
  </div>
  <div class="px-3 pt-3">
    <div class="alert d-none" id="jobs-console-alert" role="alert"></div>
  </div>
  <div class="table-responsive" id="jobs-console-table">
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th scope="col">Name</th>
          <th scope="col">Status</th>
          <th scope="col">Attempts</th>
          <th scope="col">Run At</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {{ if .RecentJobs }}
        {{ range .RecentJobs }}
        <tr>
          <td class="fw-medium">{{ .Name }}</td>
          <td><span class="badge text-bg-{{ statusColor .Status }} text-capitalize">{{ .Status }}</span></td>
          <td>{{ .Attempts }}/{{ .MaxAttempts }}</td>
          <td>{{ .RunAt.Format "2006-01-02 15:04:05" }}</td>
          <td>
            {{ if or (eq .Status "failed") (eq .Status "retry") }}
            <button type="button" class="btn btn-sm btn-outline-primary jobs-action" data-action="retry" data-id="{{ .ID }}">Retry</button>
            {{ end }}
            {{ if or (eq .Status "pending") (eq .Status "running") (eq .Status "retry") }}
            <button type="button" class="btn btn-sm btn-outline-danger jobs-action" data-action="cancel" data-id="{{ .ID }}">Cancel</button>
            {{ end }}
            {{ if and (ne .Status "failed") (ne .Status "retry") (ne .Status "pending") (ne .Status "running") }}
            <span class="text-muted small">â€”</span>
            {{ end }}
          </td>
        </tr>
        {{ end }}
        {{ else }}
        <tr>
          <td colspan="5" class="text-center text-muted py-4">Queue is empty. Schedule a job to see it tracked here.</td>
        </tr>
        {{ end }}
      </tbody>
    </table>
  </div>
</section>

<div class="modal fade" id="jobCreateModal" tabindex="-1" aria-labelledby="jobCreateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="jobCreateModalLabel">Schedule Background Job</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-success d-none" id="jobSuccessAlert">Job has been queued successfully.</div>
        <div class="alert alert-danger d-none" id="jobErrorAlert"></div>
        <form id="job-create-form" class="needs-validation" novalidate>
          <div class="mb-3">
            <label for="jobName" class="form-label">Job Name</label>
            <input type="text" class="form-control" id="jobName" name="name" value="{{ .JobForm.Name }}" required>
            <div class="form-text">Use semantic names that map to registered handlers.</div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="jobRunAt" class="form-label">Run At (UTC)</label>
              <input type="datetime-local" class="form-control" id="jobRunAt" name="run_at">
              <div class="form-text">Leave blank to run immediately.</div>
            </div>
            <div class="col-md-6">
              <label for="jobMaxAttempts" class="form-label">Max Attempts</label>
              <input type="number" class="form-control" id="jobMaxAttempts" name="max_attempts" min="1" value="{{ .JobForm.MaxAttempts }}" required>
              <div class="form-text">Retries are spaced automatically.</div>
            </div>
          </div>
          <div class="mt-3">
            <label for="jobPayload" class="form-label">Payload (JSON)</label>
            <textarea class="form-control font-monospace" id="jobPayload" name="payload" rows="5">{{ .JobForm.Payload }}</textarea>
            <div class="form-text">Provide a JSON object. Empty object defaults to <code>{}</code>.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="job-create-form" class="btn btn-primary">Queue Job</button>
      </div>
    </div>
  </div>
</div>
{{ end }}
